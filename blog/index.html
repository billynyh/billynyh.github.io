
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Just code it</title>
	<meta name="author" content="Billy Ng">

	
	<meta name="description" content="Recently read some articles from Julie Zhuo&rsquo;s, she is a Product design director in Facebook. Although her posts are not about engineering, I &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="Just code it" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script async="true" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
</head>


<body>
	<header id="header" class="inner"><h1><a href="/">Just code it</a></h1>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:billynyh.github.io/">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		
		<a class="twitter" href="http://twitter.com/billynyh" title="Twitter">Twitter</a>
		
		
		<a class="github" href="https://github.com/billynyh" title="GitHub">GitHub</a>
		
    
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
    
	</div>
	<form class="search" action="http://google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:billynyh.github.io/">
	</form>
</nav>

</header>
	
		
	
	<div id="content" class="inner">


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/03/24/gatekeeper/">
		
			The Gatekeeper</a>
	</h2>
	<div class="entry-content">
		<p>Recently read some articles from Julie Zhuo&rsquo;s, she is a Product design director in Facebook. Although her posts are not about engineering, I still feel connected with most of the topics.</p>

<p><a href="https://medium.com/the-year-of-the-looking-glass/5c48db173662">&ldquo;Don&rsquo;t be a gatekeeper&rdquo;</a></p>

<blockquote><p>If you are somebody with an incredible amount of passion for high quality, you may be compelled to become a gatekeeper at some point in your life.</p></blockquote>


<p>I read this article last night, this is interesting because I just had a similar &ldquo;discussion&rdquo; with my team leads last week about the schedule. We were doing things like other (average) startups do, fast development, no test, keep changing, dirty code everywhere. This worked for a new products, but as the usage increases, the required quality of the app should also increase.</p>

<p>I am not only not happy about the way we work, I also feel that I am losing control of my work. I start feeling I will be no longer able to maintain the app&rsquo;s performance, code quality, and even do a accurate time estimation for new tasks. This is a very serious problem as I considered myself the gatekeeper of the project, even I am not the one to make (any) product decision.</p>

<blockquote><p>If you are a gatekeeper or find yourself thinking we need a gatekeeper, the thing that is broken or missing is trust. So instead of judging yes or no, good or bad, consider this instead: what could I do to make it so that I have more trust in the people around me?</p></blockquote>


<p>The result of the discussion was that, I asked for a proper scheduling so that I can at least do my job as a developer, and hope this can change the trust thing a little bit.</p>

<h2>Futher reading</h2>

<p>There are more articles from Julie&rsquo;s <a href="https://medium.com/the-year-of-the-looking-glass">medium</a>.</p>

<p><a href="https://medium.com/the-year-of-the-looking-glass/d0aa3b8af9b7">&ldquo;Why Designers Leave&rdquo;</a></p>

<blockquote><p>Every person who works in a creative field has an aspiration for her work, a yearning for that ideal plane which is the culmination of her taste.</p><p>When an environment fails, over and over and over again, to provide her with a means to follow her internal compass, then she will leave.</p><p>If you are in a position to influence that kind of environment, take heed. Lay the foundations for a space that nurtures, that yields the kind of work the best creative people can be proud of.</p></blockquote>


<p><a href="https://medium.com/the-year-of-the-looking-glass/bcddf7c85553">&ldquo;Quality is not a tradeoff&rdquo;</a></p>

<blockquote><p>Quality is a bar, not a tradeoff.</p></blockquote>




<blockquote><p>It just doesn’t work like that.</p><p>Why? Because to create high-quality work, there has to be a minimum acceptable bar. And high-quality creators cannot trade off below that bar. They simply can’t.</p></blockquote>




		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-03-24T23:11:56+08:00" pubdate data-updated="true">Mar 24<span>th</span>, 2014</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/thoughts/'>thoughts</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/03/16/5yr-part-2-why/">
		
			Where Do You See Yourself in 5 Years - Why</a>
	</h2>
	<div class="entry-content">
		<p>It may be better in these two years, but back in 2008, people always say Hong Kong is not a good place for tech, especially for web startup. I agree, the whole environment, atmosphere, values put the industry in a big disadvantage. For example, in Hong Kong, you can make better living by doing financial related jobs, and usually have a stabler career path compared to being a programmer.</p>

<p>There is no one to blame. It is normal that a city puts more focus on some area, and has lower priority on others. Yes, HK government sometimes mention IT is one of their important industry, but do you really think the government has what it takes to do anything to help local startup on this fast changing world? I am not judging the government policy/work, I just think it is not their business.</p>

<h2>Why stay in Hong Kong</h2>

<p>So, why don&rsquo;t just go? Before I started everything, I had a short internship in Shanghai. As I mentioned in previous post, I was totally not prepared before graduate, so this internship kind of affected how I see the industry and the live of being a developer outside Hong Kong. It was a mixed experience, I did not do well, I can&rsquo;t say I enjoyed it a lot, but I did open my eye and started thinking how should I go from that point.</p>

<p>I also had an interview in US, it was a no again. I believe I would just leave HK if I got the job and things would go in a completely different way, but I am still proud of what happened next. It sounds like I was stuck in Hong Kong with no choice, there is always choices, I could keep applying but why give up Hong Kong without a try? Even the industry was bad here, I need to know how bad is it.</p>

<h2>Why work in startups</h2>

<p>From my short internship experience, I learned that if you work in a big team, most likely you will be limited to the tech they already using, it is not a bad thing since you can get deep knowledge in that area, but I was not sure if it was good for me in that time. Touching different latest technologies in development is important to me, it shows how the developers around the world work and keeps you in the trend. You can always try out new stuff in your own time, but as newbie like me, I will need to spend my own time on catching up work. Therefore, working in a (new/small) startup that opens to different technologies would be a best fit to me.</p>

<p>In terms of earnings, working in startup would probably at the bottom of the list amount the jobs required similar skill level. Mathematically you can say you had the possibility of going big in a startup but 0 chance of not doing that. But if this is really the reason of doing startup, you are either very confident in yourself and your team, or you are not go at math&hellip;</p>

<p>There is no doubt that I want the startup I am working in goes big one day, but it is not the only thing I care. Besides the result, I value the process even higher. What working in startup means to me is, even you are in a small team and do not have many resources compare to big companies, you can still do something big. To do that, you need to optimize the time, tools, resource you have and keep challenge your team to improve.</p>

<h2>What&rsquo;s next</h2>

<p>After working in different startups for 5 years, I think I am still learning and improving as an engineer. I believe someday when I am more experienced and my skill reached certain level, I may have a different view of everything. I am looking forward for what will happen on me and the industry in the next 5 years.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-03-16T22:55:02+08:00" pubdate data-updated="true">Mar 16<span>th</span>, 2014</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/5yr/'>5yr</a>, <a class='category' href='/blog/categories/thoughts/'>thoughts</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/03/09/quartz-composer-origami/">
		
			Try Out Quartz Composer and Origami</a>
	</h2>
	<div class="entry-content">
		<p>In late Jan, I watched a <a href="https://www.youtube.com/watch/?v=s5kNm-DgyjY">talk &ndash; Bringing Beautiful Interactions to Android Apps</a> from Facebook about how they use Quartz Composer(QC) when developing Facebok Home (and chat head). Compare to other prototyping tools, QC can better illustrate animations and interactions. It is quite impressive and I actually installed QC the day after and tried to play on it. But when I first opened it, I was totally lost, not saying it is hard to use, but it is obvious that there is a learning curve on this tool. I did not spend more time on it that time but kept it in my TODO list.</p>

<div class="video-container">
<iframe src="http://www.youtube.com/embed/s5kNm-DgyjY" frameborder="0" allowfullscreen></iframe>
</div>


<p>Two weeks later, Facebook released <a href="http://facebook.github.io/origami/">Origami</a>, an extension of QC. Followed with some articles about how it is used in Facebook. Yesterday I gave it another try. This time I am more serious compared to last time. My target is at least understand (not fully) how it works and be able to do a simple demo to my team.</p>

<h2>Let&rsquo;s start</h2>

<p>This time I started with the <a href="https://developer.apple.com/library/mac/documentation/graphicsimaging/conceptual/quartzcomposeruserguide/qc_intro/qc_intro.html">documentation</a>, not saying it is poorly documented, but it is not much fun to read it(my bad)&hellip; Then I went for tutorials, after a quick look of some articles on QC (not Origami), I had little concept of patches (but missed macro patch&hellip;), then I think maybe I can understand the Origami examples.</p>

<p>When I opened the &ldquo;Photo Grid&rdquo; example, I only see three patches, I knew that there must be some hierarchy hidden from the interface, I tried to use the patch inspector to look around but have no idea where to go, I was stuck again. Then I found this <a href="http://vimeo.com/85578380">video</a> on Origami&rsquo;s twitter, which turned out was everything I needed.</p>

<div class="video-container">
<iframe src="http://player.vimeo.com/video/85578380" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe> 
</div>


<pre><code>It is the visual version spaghetti code // 6:50
</code></pre>

<h2>Short notes</h2>

<ul>
<li>&ldquo;Phone&rdquo; patch is the basic component for the phone prototype, which displays an image in device frame.</li>
<li>Use &ldquo;Render in Image&rdquo; for the content to display.</li>
<li>Double click the &ldquo;Render in Image&rdquo; patch to edit the macro patch of it.</li>
<li>A &ldquo;Layer&rdquo; patch will be automatically added when you drag in an image.</li>
</ul>


<p><img src="/images/posts/20140309/qc-1.jpg"/></p></p>

<h2>Reference</h2>

<ul>
<li><a href="http://facebook.github.io/origami/">http://facebook.github.io/origami/</a></li>
<li><a href="https://medium.com/the-year-of-the-looking-glass/f1173d0bd181">Introducing Origami for Quartz Composer</a></li>
<li><a href="http://www.wired.com/wiredenterprise/2014/03/facebook-paper/">Facebook Paper Has Forever Changed the Way We Build Mobile Apps</a></li>
<li><a href="http://vimeo.com/85578380">Vimeo &ndash; Prototyping with Facebook Origami</a>

<ul>
<li>Asset for the example <a href="https://github.com/jaythrash/spy-book">https://github.com/jaythrash/spy-book</a></li>
</ul>
</li>
<li><a href="https://www.youtube.com/watch/?v=s5kNm-DgyjY">Youtube &ndash; Bringing Beautiful Interactions to Android Apps &ndash; Mobile @ Scale</a></li>
</ul>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-03-09T19:59:11+08:00" pubdate data-updated="true">Mar 9<span>th</span>, 2014</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/prototyping/'>prototyping</a>, <a class='category' href='/blog/categories/ux/'>ux</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/03/08/5yr-part-1/">
		
			Where Do You See Yourself in 5 Years - How I Started</a>
	</h2>
	<div class="entry-content">
		<h2>5 years ago</h2>

<p><strong>Where do you see yourself in 5 years</strong>. This was the very first question I got asked in an interview after graduated from university in 2008. I started as a web developer, also touched a little bit iOS. Then I decided to focus on Android and now I am a pure Android developer, nothing close to an expert, but I know what I can do and I am confident in my work.</p>

<p>Of course I did not picture me being Android developer 5 years ago, but other than that, I did foresee myself focused on one area instead of touching everything. Not saying that I am now Android only, but if there is one thing I have better knowledge compare to others in my team, it would be Android.</p>

<div style="background:#ccc; padding:20px">
<p style="text-align:center">
<img src="/images/posts/20140308/five-years.png"/></p>
<p style="text-align:right"><a href="http://xkcd.com/1088/">Source: xkcd</a></p>
</div>


<p>Back in 2008, I enjoyed my 3 years programming competition life and knew absolutely nothing about the real world. I wanted to be a software engineer but had no idea what its like before I graduated (I am not saying it is a bad thing, having work experience before graduate means very little to me, but you may feel a little bit lost at the beginning). I even didn&rsquo;t prepare for that interview, or you can say, that interview was my preparation of the next interview.</p>

<p>My first reaction on that 5yr question was like, I know nothing about your company, most likely I will not be there 5 years later, what should I say? Is it a trick question? As expected, I did not get the job but this question stays in my head through out the years.</p>

<p>After some friends&#8217; referral and meeting different people, I joined a new, small and passionate &ldquo;startup + software house&rdquo; team and started my developer life. I started as a web developer, learning all kind of web tech through client projects, first did some Wordpress theme, then some rails, python and mongodb. Doing projects with different languages and frameworks gave me a chance to play with latest tech outside and most importantly, pushed my learning skill.</p>

<h2>Android</h2>

<p>Around that time, iPhone was in a very good trend and we started to have some iOS projects. Even I participated in some, I was not a big fan of smart phone as I was already with my computer all day.</p>

<p>In 2010, I got my first smart phone, Google Nexus One, it did not magically changed how I see smart phone in a short time. I actually was still not so convinced by the idea of smart phone in the first few months. What happened was that, one day we decided to play with the Android sdk and build something we want (and simple). This was mainly for fun, and also to let us had a taste of Android development so we might take some Android project in the future.</p>

<p>We decided to make a camera app as side project, because we did see some good camera apps on iOS but those on Android were not compareable to them. Turned out it is nothing close to simple, or I should say, it was one of the hardest thing you can do within the computing power at that time. We spent one week to have our first prototype, everything was ugly, but we just put it on Android market right away. We did not know what to expect, but we were happy to see people actually enjoyed our app. Then I started maintaining the app in my own time and took that chance to catch up with the latest Android development. We learned a lot from building that app, it is a long story so I will not include it here.</p>

<h2>Leaving the comfort zone</h2>

<p>I stayed in my first company for 3 years. Although we did not go big or have any crazy viral product, we survived, which I think already is an achievement in Hong Kong. I enjoy being a (big) part of the team but I started thinking that 5 years question. I could basically see how I would be if nothing changed and I was not sure if it is what I want. There were other considerations but in short, I decided to leave my comfort zone. I quited my job in early 2012, took a little break and threw myself back to the market.</p>

<p>This time, I started as an Android developer.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-03-08T22:41:19+08:00" pubdate data-updated="true">Mar 8<span>th</span>, 2014</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/5yr/'>5yr</a>, <a class='category' href='/blog/categories/thoughts/'>thoughts</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/03/02/fragment-state-pager-adapter/">
		
			A Deeper Look of ViewPager and FragmentStatePagerAdaper</a>
	</h2>
	<div class="entry-content">
		<h2>Background</h2>

<p>Last week I was working on a remove action on ViewPager, so based on the knowledge from ListView&rsquo;s adapter, I tried removing the item and called notifyDataSetChanged, it didn&rsquo;t work. So I googled a little bit and found that I need to override the getItemPosition method in PagerAdapter when removing item.</p>

<p>This is the doc from PagerAdapter</p>

<blockquote><p>A data set change may involve pages being added, removed, or changing position. The ViewPager will keep the current page active provided the adapter implements the method getItemPosition(Object).</p></blockquote>

<p>and description of getItemPosition</p>

<blockquote><p>Called when the host view is attempting to determine if an item&rsquo;s position has changed. Returns POSITION_UNCHANGED if the position of the given item has not changed or POSITION_NONE if the item is no longer present in the adapter.</p></blockquote>

<p>Then I put it in my pager adapter, got a different behavior, but still not work correctly. Three thoughts came to me immediately:</p>

<ol>
<li>something wrong in my getItemPosition</li>
<li>something wrong when I integrate with my other code.</li>
<li>something wrong in FragmentStatePagerAdapter</li>
</ol>


<p>For 1, it is easy to verify by printing logs and it looked good to me. 2, I don&rsquo;t think so but still spend some time to check my code first. As expected, problem still existed. I always have a problem with Fragment lifecycle, everytime I thought I understand more, a new problem came out and breaks my understanding of fragment lifecycle. I tried hard to avoid go deep to the implementation of FragmentStatePagerAdapter, but this time I have no choice.</p>

<h2>FragmentStatePagerAdapter</h2>

<p>I am a little bit surprised by the <a href="https://android.googlesource.com/platform/frameworks/support/+/refs/heads/master/v4/java/android/support/v4/app/FragmentStatePagerAdapter.java">short code length</a> of it.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="c1">//https://android.googlesource.com/platform/frameworks/support/+/refs/heads/master/v4/java/android/support/v4/app/FragmentStatePagerAdapter.java</span>
</span><span class='line'><span class="kd">private</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Fragment</span><span class="o">&gt;</span> <span class="n">mFragments</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Fragment</span><span class="o">&gt;();</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@Override</span>
</span><span class='line'><span class="kd">public</span> <span class="n">Object</span> <span class="nf">instantiateItem</span><span class="o">(</span><span class="n">ViewGroup</span> <span class="n">container</span><span class="o">,</span> <span class="kt">int</span> <span class="n">position</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">mFragments</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">position</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Fragment</span> <span class="n">f</span> <span class="o">=</span> <span class="n">mFragments</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">position</span><span class="o">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">f</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">f</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">mCurTransaction</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">mCurTransaction</span> <span class="o">=</span> <span class="n">mFragmentManager</span><span class="o">.</span><span class="na">beginTransaction</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Fragment</span> <span class="n">fragment</span> <span class="o">=</span> <span class="n">getItem</span><span class="o">(</span><span class="n">position</span><span class="o">);</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>    <span class="n">mFragments</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">position</span><span class="o">,</span> <span class="n">fragment</span><span class="o">);</span>
</span><span class='line'>    <span class="n">mCurTransaction</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">container</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="n">fragment</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">fragment</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@Override</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">destroyItem</span><span class="o">(</span><span class="n">ViewGroup</span> <span class="n">container</span><span class="o">,</span> <span class="kt">int</span> <span class="n">position</span><span class="o">,</span> <span class="n">Object</span> <span class="n">object</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">Fragment</span> <span class="n">fragment</span> <span class="o">=</span> <span class="o">(</span><span class="n">Fragment</span><span class="o">)</span><span class="n">object</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">mCurTransaction</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">mCurTransaction</span> <span class="o">=</span> <span class="n">mFragmentManager</span><span class="o">.</span><span class="na">beginTransaction</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>    <span class="n">mSavedState</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">position</span><span class="o">,</span> <span class="n">mFragmentManager</span><span class="o">.</span><span class="na">saveFragmentInstanceState</span><span class="o">(</span><span class="n">fragment</span><span class="o">));</span>
</span><span class='line'>    <span class="n">mFragments</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">position</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">mCurTransaction</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">fragment</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here is what FragmentStatePagerAdapter does in instantiateItem and destroyItem, in short, it maintains an ArrayList mFragments which mFragments.get(i) returns the fragment that is in position i, null if fragment not in fragment manager. By default, ViewPager will keep one item before and after current item, so if you are at position 1 (0-based), mFragments will be like</p>

<table>
<thead>
<tr>
<th> 0 </th>
<th> 1 </th>
<th> 2 </th>
<th> 3 </th>
<th> 4 </th>
</tr>
</thead>
<tbody>
<tr>
<td> F0 </td>
<td> F1 </td>
<td> F2 </td>
<td> null </td>
<td> null </td>
</tr>
</tbody>
</table>


<h2>Remove item</h2>

<p>What will happen if I remove F1 and call notifyDataSetChanged? the result of getItemPosition should be</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>F0: 0 (or POSITION_UNCHANGED?)
</span><span class='line'>F1: POSITION_NONE
</span><span class='line'>F2: 1</span></code></pre></td></tr></table></div></figure>


<p>Right?</p>

<p>Then I expect mFragments become</p>

<table>
<thead>
<tr>
<th> 0 </th>
<th> 1 </th>
<th> 2 </th>
<th> 3 </th>
<th> 4 </th>
</tr>
</thead>
<tbody>
<tr>
<td> F0 </td>
<td> F2 </td>
<td> null </td>
<td> null </td>
<td> null </td>
</tr>
</tbody>
</table>


<p>But from the source of FragmentStatePagerAdapter, I don&rsquo;t think it has any handling of it. I copied the source and added some log to dump mFragments out, and find that it is like</p>

<table>
<thead>
<tr>
<th align="left"> Step </th>
<th> What I see </th>
<th> 0 </th>
<th> 1 </th>
<th> 2 </th>
<th> 3 </th>
<th> 4 </th>
</tr>
</thead>
<tbody>
<tr>
<td align="left"> 1 </td>
<td>curr item F1 </td>
<td> F0 </td>
<td> F1 </td>
<td> F2 </td>
<td> null </td>
<td> null </td>
</tr>
<tr>
<td align="left"> 2 </td>
<td>after remove F1, F2 becomes curr item </td>
<td> F0 </td>
<td> null </td>
<td>  F2 </td>
<td> null </td>
<td> null </td>
</tr>
<tr>
<td align="left"> 3 </td>
<td>swipe next, no item displayed but F4 instantiated </td>
<td> null </td>
<td> null </td>
<td> F2 </td>
<td> F4 </td>
<td> null </td>
</tr>
<tr>
<td align="left"> 4 </td>
<td>swipe next, curr item F4 </td>
<td> null </td>
<td> null </td>
<td> F2 </td>
<td> F4 </td>
<td> F5 </td>
</tr>
<tr>
<td align="left"> 5 </td>
<td>swipe next, curr item F5 </td>
<td> null </td>
<td> null </td>
<td> null </td>
<td> F4 </td>
<td> F5 </td>
</tr>
</tbody>
</table>


<p>then the app crashed on step 5 when it tries to destroy F2.</p>

<h2>Dafaq?</h2>

<p>First of all, what happened in step 2? It just removed F1 and left F2 there, and ViewPager just display it?</p>

<p>Yes, something like that.</p>

<ol>
<li>When F1 is removed and called notifyDataSetChanged, ViewPager will call getItemPosition for each item, in the order of F0, F1, F2.</li>
<li>When POSITION_NONE is returned for F1, adapter&rsquo;s destroyItem is called and F1 is removed from FragmentManager and mFragments.</li>
<li>Then for F2, it returned the new position 1, which match the current position, so ViewPager uses F2 directly, but <strong>leave mFragments in adapter not updated</strong>.</li>
<li>After that, it should create F3 by calling instantiateItem on position 2, however, as mFragments still keeping F2 in position 2, it is directly returned and F3 is never created.</li>
<li>In the first swipe after remove, ViewPager tries to display data in position 2 which the fragment F2 is already used in position 1. At the same time, F0 is removed from FragmentManager, F4 is created as item in position 3.</li>
<li>Second swipe, position 3(F4) becomes current item, position 1(F2) removed from FragmentManager, F5 created for position 4.</li>
<li>Third swipe, position 4(F5) becomes current item, ViewPager tried to destroy position 2, but position 2 is also F2, destroying that cause

<blockquote><p>IllegalStateException: Fragment {} is not currently in the FragmentManager.</p></blockquote></li>
</ol>


<h2>Workaround</h2>

<p>When I tried to isolate the problem, I accidentally return POSITION_NONE for all item, and it actually gave the result I want without crash. It worked because all fragments are destroyed in notifyDataSetChanged and re-instantiated, it does the tricks but may cause other performance problem so I am looking for a better solution.</p>

<h2>Possible fix</h2>

<p>I have not start yet, but as mFragments in FragmentStatePagerAdapter is private, extending it and override some methods cannot change it at all. Good news is, you can copy the source and compile it yourself.</p>

<p>To fix this, you need to find a way to update mFragments after checking getItemPosition and destroyItem. My initial thoughts is to handle that in finishUpdate(). The new finishUpdate will become something like:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Override</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">finishUpdate</span><span class="o">(</span><span class="n">ViewGroup</span> <span class="n">container</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">mCurTransaction</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">mCurTransaction</span><span class="o">.</span><span class="na">commitAllowingStateLoss</span><span class="o">();</span>
</span><span class='line'>        <span class="n">mCurTransaction</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>        <span class="n">mFragmentManager</span><span class="o">.</span><span class="na">executePendingTransactions</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Fragment</span><span class="o">&gt;</span> <span class="n">update</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Fragment</span><span class="o">&gt;();</span>
</span><span class='line'>    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">,</span> <span class="n">n</span><span class="o">=</span><span class="n">mFragments</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Fragment</span> <span class="n">f</span> <span class="o">=</span> <span class="n">mFragments</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">f</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">continue</span><span class="o">;</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">getItemPosition</span><span class="o">(</span><span class="n">f</span><span class="o">);</span>
</span><span class='line'>        <span class="k">while</span> <span class="o">(</span><span class="n">update</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&lt;=</span> <span class="n">pos</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">update</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="n">update</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">pos</span><span class="o">,</span> <span class="n">f</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="n">mFragments</span> <span class="o">=</span> <span class="n">update</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>One problem is that finishUpdate is also called in other places so need to make sure this change will not break other code and not causing performance issue.</p>

<h2>About this post&hellip;</h2>

<p>At first I just want to write a short notes on the problem I met during work, then I tried to isolate the problem and reproduce it, tried to find similar posts on stackoverflow, read the soure code to confirm the problem, and even tried to fix it&hellip; This is totally not my plan for this weekend but I actually quite enjoy reading the source code of support library.</p>

<h2>Reference</h2>

<ul>
<li><a href="https://plus.google.com/u/0/105980838674582844427/posts/a1xwgEEehCs">Discussion on gplus</a> thx Adam Powell for replying my post.</li>
<li>Source of <a href="https://android.googlesource.com/platform/frameworks/support/+/refs/heads/master/v4/java/android/support/v4/view/ViewPager.java">ViewPager</a> and <a href="https://android.googlesource.com/platform/frameworks/support/+/refs/heads/master/v4/java/android/support/v4/app/FragmentStatePagerAdapter.java">FragmentStatePagerAdapter</a></li>
<li><a href="https://code.google.com/p/android/issues/detail?id=37990">https://code.google.com/p/android/issues/detail?id=37990</a></li>
</ul>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-03-02T21:01:40+08:00" pubdate data-updated="true">Mar 2<span>nd</span>, 2014</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/android/'>android</a>, <a class='category' href='/blog/categories/viewpager/'>viewpager</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/02/23/features-missed-during-development/">
		
			Useful Features I Missed During Android Development</a>
	</h2>
	<div class="entry-content">
		<p>This weekend, I am working on my Muzei extension and try to add a setting page to it. It is not hard to write everything myself, but I was not in the mood of writing code from scratch, so I just copy code from <a href="https://github.com/flavienlaurent/muzeihash">other opensource project</a>. Modifying other&rsquo;s code does not always speed up your development when your task is so simple, but you can take this chance to read other&rsquo;s code at the same time.</p>

<p>I don&rsquo;t consider myself learned Android development correctly, but I guess most people started like me. I started with a small project, lookup the doc for the features I need, then learn other features while doing other projects.When you learn like this, it is easy to miss out simple features. Here are what I found this week:</p>

<h2>Show divider in LinearLayout</h2>

<p>Can&rsquo;t believe I missed this, there was a couple times that I need to append dummy view to act as divider. The worst thing about adding divider view yourself is not the extra code you added, is when you try to control visiblity of elements, you need to handle the dividers also.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="o">&lt;</span><span class="n">LinearLayout</span> <span class="nl">xmlns:</span><span class="n">android</span><span class="o">=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
</span><span class='line'>    <span class="nl">android:</span><span class="n">layout_width</span><span class="o">=</span><span class="s">&quot;match_parent&quot;</span>
</span><span class='line'>    <span class="nl">android:</span><span class="n">layout_height</span><span class="o">=</span><span class="s">&quot;match_parent&quot;</span>
</span><span class='line'>    <span class="nl">android:</span><span class="n">orientation</span><span class="o">=</span><span class="s">&quot;horizontal&quot;</span>
</span><span class='line'>    <span class="nl">android:</span><span class="n">showDividers</span><span class="o">=</span><span class="s">&quot;middle&quot;</span>
</span><span class='line'>    <span class="nl">android:</span><span class="n">divider</span><span class="o">=</span><span class="s">&quot;?android:dividerVertical&quot;</span>
</span><span class='line'>    <span class="nl">android:</span><span class="n">dividerPadding</span><span class="o">=</span><span class="s">&quot;4dp&quot;</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">LinearLayout</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>CheckedTextView</h2>

<p>The first time when I want to have checkbox put on the right side of the text, I went through the available options of CheckBox class and cannot find any good, then I go to google and stackoverflow, <a href="http://stackoverflow.com/questions/5000213/how-to-set-the-checkbox-on-the-right-side-of-the-text">first solution</a> is to put a TextView to the left of CheckBox. Usually I will just stop here and start coding, but it is obviously not good enoguh, as now you can only trigger it by clicking the checkbox but not the whole text+checkbox.</p>

<p>If you tried the multiple choice feature of ListView, you will see it is exactly the behavior you look for, a little <a href="https://android.googlesource.com/platform/frameworks/base/+/master/core/res/res/layout/simple_list_item_multiple_choice.xml">dig in</a> will give you CheckedTextView.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="o">&lt;</span><span class="n">CheckedTextView</span> <span class="nl">xmlns:</span><span class="n">android</span><span class="o">=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
</span><span class='line'>    <span class="nl">android:</span><span class="n">id</span><span class="o">=</span><span class="s">&quot;@android:id/text1&quot;</span>
</span><span class='line'>    <span class="nl">android:</span><span class="n">layout_width</span><span class="o">=</span><span class="s">&quot;match_parent&quot;</span>
</span><span class='line'>    <span class="nl">android:</span><span class="n">layout_height</span><span class="o">=</span><span class="s">&quot;?android:attr/listPreferredItemHeightSmall&quot;</span>
</span><span class='line'>    <span class="nl">android:</span><span class="n">textAppearance</span><span class="o">=</span><span class="s">&quot;?android:attr/textAppearanceListItemSmall&quot;</span>
</span><span class='line'>    <span class="nl">android:</span><span class="n">gravity</span><span class="o">=</span><span class="s">&quot;center_vertical&quot;</span>
</span><span class='line'>    <span class="nl">android:</span><span class="n">checkMark</span><span class="o">=</span><span class="s">&quot;?android:attr/listChoiceIndicatorMultiple&quot;</span>
</span><span class='line'>    <span class="nl">android:</span><span class="n">paddingStart</span><span class="o">=</span><span class="s">&quot;?android:attr/listPreferredItemPaddingStart&quot;</span>
</span><span class='line'>    <span class="nl">android:</span><span class="n">paddingEnd</span><span class="o">=</span><span class="s">&quot;?android:attr/listPreferredItemPaddingEnd&quot;</span>
</span><span class='line'><span class="o">/&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can even extend other layout with <a href="http://developer.android.com/reference/android/widget/Checkable.html">Checkable</a> interface, more detail <a href="http://chris.banes.me/2013/03/22/checkable-views/">here</a></p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-02-23T19:36:59+08:00" pubdate data-updated="true">Feb 23<span>rd</span>, 2014</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/android/'>android</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/02/16/first-play-on-muzei/">
		
			First Play on Muzei</a>
	</h2>
	<div class="entry-content">
		<p><a href="https://github.com/romannurik/muzei">Muzei live wallpaper</a> is a new opensource project from Roman Nurik which provide a nice API for other developers to build extension on it easily. Just a few days after its release on Feb 12, you can already find quite many different <a href="https://play.google.com/store/search?q=muzei&amp;c=apps">data source</a> for it. So I played for a while today and found that it is&hellip; really easy to implement your own data source.</p>

<p>Here is a quick start on creating the extension.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyArtSource</span> <span class="kd">extends</span> <span class="n">RemoteMuzeiArtSource</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">UPDATE_INTERVAL</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">;</span> <span class="c1">// 60min</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="nf">MyArtSource</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="kd">super</span><span class="o">(</span><span class="s">&quot;my-art-source&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">();</span>
</span><span class='line'>        <span class="n">setUserCommands</span><span class="o">(</span><span class="n">BUILTIN_COMMAND_ID_NEXT_ARTWORK</span><span class="o">);</span> <span class="c1">// manual switch image</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onTryUpdate</span><span class="o">(</span><span class="kt">int</span> <span class="n">reason</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">RetryException</span> <span class="o">{</span>
</span><span class='line'>        <span class="c1">// fetch title, imageUrl, id, url from remote or hardcode</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">publishArtwork</span><span class="o">(</span><span class="k">new</span> <span class="n">Artwork</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
</span><span class='line'>            <span class="o">.</span><span class="na">title</span><span class="o">(</span><span class="n">title</span><span class="o">)</span>
</span><span class='line'>            <span class="o">.</span><span class="na">imageUri</span><span class="o">(</span><span class="n">Uri</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">imageUrl</span><span class="o">))</span>
</span><span class='line'>            <span class="o">.</span><span class="na">token</span><span class="o">(</span><span class="n">id</span><span class="o">)</span>
</span><span class='line'>            <span class="o">.</span><span class="na">viewIntent</span><span class="o">(</span><span class="k">new</span> <span class="n">Intent</span><span class="o">(</span><span class="n">Intent</span><span class="o">.</span><span class="na">ACTION_VIEW</span><span class="o">,</span> <span class="n">Uri</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">url</span><span class="o">)))</span>
</span><span class='line'>            <span class="o">.</span><span class="na">build</span><span class="o">());</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">scheduleUpdate</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">+</span> <span class="n">UPDATE_INTERVAL</span><span class="o">);</span> <span class="c1">// switch image after 60min</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can find my Muzei 9GAG extension on <a href="https://play.google.com/store/apps/details?id=com.billynyh.muzei9gag">Play store</a>, source code available on <a href="https://github.com/billynyh/android-muzei-9gag">Github</a></p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-02-16T23:05:43+08:00" pubdate data-updated="true">Feb 16<span>th</span>, 2014</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/android/'>android</a>, <a class='category' href='/blog/categories/github/'>github</a>, <a class='category' href='/blog/categories/muzei/'>muzei</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/02/15/implmenting-view-gesture-1/">
		
			Implementing Zoomable View - Part 1</a>
	</h2>
	<div class="entry-content">
		<p>Last year I implemented a custom view that supports different gestures including zoom(scale), scroll, double tap. As a newbie on custom view, the whole measuring and drawing already spent me some time, so the gesture control turned out enough to use but was actually incomplete and not finished.</p>

<p>Recently, I have a task to embed my custom view to ViewPager and other custom ViewGroup that intercept touch events. As expected, my custom view takes all the touch events so the ViewPager cannot perform horizontal swipe. I woule like to take this chance to review my gesture handling and hopefully can make it work.</p>

<p>What I did last year is mostly referencing Chris Banes&rsquo;s <a href="https://github.com/chrisbanes/PhotoView/blob/master/library/src/uk/co/senab/photoview/PhotoViewAttacher.java">PhotoView library</a>. The basic idea is:</p>

<ul>
<li>create a &ldquo;view attacher&rdquo; that implements a View.OnTouchListener</li>
<li>create instance of <a href="http://developer.android.com/reference/android/view/ScaleGestureDetector.html">ScaleGesutreDetector</a> and <a href="http://developer.android.com/reference/android/view/GestureDetector.html">GestureDetector</a>, notice that <a href="https://github.com/chrisbanes/PhotoView/blob/master/library/src/uk/co/senab/photoview/gestures/GestureDetector.java">PhotoView&rsquo;s GestureDetector</a> is not the one in Android framework</li>
<li>use those detectors in OnTouchListener&rsquo;s onTouch method</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ZoomableViewAttacher</span> <span class="kd">implements</span> <span class="n">View</span><span class="o">.</span><span class="na">OnTouchListener</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">GestureDetector</span> <span class="n">mGestureDetector</span><span class="o">;</span>
</span><span class='line'>    <span class="n">ScaleGestureDetector</span> <span class="n">mScaleGestureDetector</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">onTouch</span><span class="o">(</span><span class="n">View</span> <span class="n">v</span><span class="o">,</span> <span class="n">MotionEvent</span> <span class="n">ev</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="kt">boolean</span> <span class="n">handled</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="o">...</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="n">mGestureDetector</span> <span class="o">&amp;&amp;</span> <span class="n">mGestureDetector</span><span class="o">.</span><span class="na">onTouchEvent</span><span class="o">(</span><span class="n">ev</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">handled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="n">mScaleGestureDetector</span> <span class="o">&amp;&amp;</span> <span class="n">mScaleGestureDetector</span><span class="o">.</span><span class="na">onTouchEvent</span><span class="o">(</span><span class="n">ev</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">handled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">handled</span><span class="o">;</span> <span class="c1">// or just return true;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>So far this worked for me last year as I am using the view alone, I did not have to consider the case that the view&rsquo;s parent intercepted the touch event.</p>

<p>Now the problem is, how do I prevent the ViewPager intercepting my touch event? After digging deeper, I found a requestDisallowInterceptTouchEvent method in ViewParent. According to the framework <a href="http://developer.android.com/reference/android/view/ViewParent.html#requestDisallowInterceptTouchEvent(boolean)">doc</a></p>

<blockquote><p>Called when a child does not want this parent and its ancestors to intercept touch events with onInterceptTouchEvent(MotionEvent).</p><p>This parent should pass this call onto its parents. This parent must obey this request for the duration of the touch (that is, only clear the flag after this parent has received an up or a cancel.</p></blockquote>


<p>Which means, if I call the method in correct time, I should be able to enable and disable ViewPager&rsquo;s onInterceptTouchEvent. Googled a little bit on requestDisallowInterceptTouchEvent, found some example on StackOverflow like</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="k">switch</span> <span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">getAction</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">case</span> <span class="n">MotionEvent</span><span class="o">.</span><span class="na">ACTION_DOWN</span><span class="o">:</span>
</span><span class='line'>        <span class="n">parent</span><span class="o">.</span><span class="na">requestDisallowInterceptTouchEvent</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span><span class='line'>        <span class="k">break</span><span class="o">;</span>
</span><span class='line'>    <span class="k">case</span> <span class="n">MotionEvent</span><span class="o">.</span><span class="na">ACTION_CANCEL</span><span class="o">:</span>
</span><span class='line'>    <span class="k">case</span> <span class="n">MotionEvent</span><span class="o">.</span><span class="na">ACTION_UP</span><span class="o">:</span>
</span><span class='line'>        <span class="n">parent</span><span class="o">.</span><span class="na">requestDisallowInterceptTouchEvent</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
</span><span class='line'>        <span class="k">break</span><span class="o">;</span>
</span><span class='line'>    <span class="k">default</span><span class="o">:</span>
</span><span class='line'>        <span class="k">break</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is obviously not enough for me, since it disabled the parent for the whole touch motion, if I touch on my custom and actually want to perform a page swipe on ViewPager, thie code will definitely break the ViewPager usage.</p>

<p>My first attempt is something like:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="k">switch</span> <span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">getAction</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">case</span> <span class="n">MotionEvent</span><span class="o">.</span><span class="na">ACTION_DOWN</span><span class="o">:</span>
</span><span class='line'>        <span class="n">parent</span><span class="o">.</span><span class="na">requestDisallowInterceptTouchEvent</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span><span class='line'>        <span class="k">break</span><span class="o">;</span>
</span><span class='line'>    <span class="k">case</span> <span class="n">MotionEvent</span><span class="o">.</span><span class="na">ACTION_CANCEL</span><span class="o">:</span>
</span><span class='line'>    <span class="k">case</span> <span class="n">MotionEvent</span><span class="o">.</span><span class="na">ACTION_UP</span><span class="o">:</span>
</span><span class='line'>        <span class="n">parent</span><span class="o">.</span><span class="na">requestDisallowInterceptTouchEvent</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
</span><span class='line'>        <span class="k">break</span><span class="o">;</span>
</span><span class='line'>    <span class="k">default</span><span class="o">:</span>
</span><span class='line'>        <span class="k">break</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="o">(!</span><span class="n">canScroll</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>        <span class="c1">// re-enable parents&#39; onInterceptTouchEvent</span>
</span><span class='line'>        <span class="n">parent</span><span class="o">.</span><span class="na">requestDisallowInterceptTouchEvent</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>It would be great if GestureDetector can directly give me the information needed for my canScroll() method. However, it seems that GestureDetector need a few events to determine if it is a scroll, there is a gap of 3-5 events between my first ACTION_DOWN and onScoll callback, so I need a better way to determine the condition for calling parent.requestDisallowInterceptTouchEvent().</p>

<p>In part 2, I will continue with the implementation of canScroll() method.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-02-15T22:27:54+08:00" pubdate data-updated="true">Feb 15<span>th</span>, 2014</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/android/'>android</a>, <a class='category' href='/blog/categories/gesture/'>gesture</a>, <a class='category' href='/blog/categories/view/'>view</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/01/18/collections/">
		
			Android Development Resources Collections</a>
	</h2>
	<div class="entry-content">
		<h3>Recently read</h3>

<ul>
<li>GTAC 2013 <a href="https://developers.google.com/google-test-automation-conference/2013/presentations">presentations</a> * <a href="http://www.youtube.com/watch?v=HUE_yrd8tl0">How Facebook Tests Facebook on Android</a>

<ul>
<li><a href="http://goo.gl/278b4">Slides</a></li>
</ul>
</li>
</ul>


<div class="video-container">
<iframe src="http://www.youtube.com/embed/HUE_yrd8tl0" frameborder="0" allowfullscreen></iframe>
</div>


<p></p>

<ul>
<li>Facebook: <a href="https://code.facebook.com/mobile/">mobile engi blog</a>, <a href="https://github.com/facebook">github</a>

<ul>
<li><a href="https://code.facebook.com/posts/454616284650560/building-a-faster-messenger/">Building a faster Messenger</a>

<blockquote><p>Michael Marucheck, had the idea to actually edit the Java byte code after compilation. We used ASM to improve our dependency injection system by detecting bindings that are safe to remove, adding static methods that instantiate a bound type, and rewriting calls to the injector to instead call the appropriate static method. By improving this process, we were able to have a well-crafted dependency injection system that lets us test at scale, but still with the 30% gain in speed.</p></blockquote></li>
</ul>
</li>
</ul>


<h3>Other</h3>

<ul>
<li>Twitter: <a href="https://www.youtube.com/user/TwitterUniversity/videos">youtube</a></li>
<li>Square: <a href="http://corner.squareup.com/">engi blog</a>, <a href="https://github.com/square">github</a></li>
<li>Etsy: <a href="http://codeascraft.com/category/mobile/">blog &ndash; mobile</a>, <a href="https://github.com/etsy">github</a></li>
<li>Pocket: <a href="http://getpocket.com/blog/category/development/">blog &ndash; dev</a></li>
<li>Feedly: <a href="http://blog.feedly.com/">blog</a></li>
<li>Romain Guy: <a href="http://www.curious-creature.org/category/android/">blog</a>, <a href="https://speakerdeck.com/romainguy">speaker deck</a></li>
</ul>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-01-18T23:48:54+08:00" pubdate data-updated="true">Jan 18<span>th</span>, 2014</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/android/'>android</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2013/12/23/my-2013-development/">
		
			My 2013 Android Development</a>
	</h2>
	<div class="entry-content">
		<p>2013 was a fresh start for me. I joined a new team, started the Android product from scratch, get a nice number of active users and keep it growing. During my development, I referenced many opensource projects and learnt alot from them.</p>

<h3><a href="https://github.com/kevinsawicki/http-request">kevinsawicki/http-request</a></h3>

<p>This is the very first library I added to my project (support-v4 does not count). This library provided a nice wrap of http call. I am not sure if this can be used with other network library like square/okhttp and android/volley, hope I have time to try it out in 2014.</p>

<h3><a href="https://github.com/jfeinstein10/SlidingMenu">jfeinstein10/SlidingMenu</a></h3>

<p>This is the sliding menu I used at the beginning, I like the effect very much. Although I switched to Android DrawerLayout after it was introduced in support-v4, I do like the old SlidingMenu more. Personally I like to have the drawer push the content out, DrawerLayout is more like an overlay, they both make sense to me, let see will the design guideline include this kind of UI also.</p>

<h3><a href="https://github.com/square/otto">square/otto</a></h3>

<p>I am a big fan of Square opensource projects but I was not using any event bus so when I saw otto I did not get it at first. When things getting complicated that you cannot write everything in your Activity/Fragment, you will try to split the logic to different components. The old school way to communicate between components is implements some kind of listener, it works for a while, a short while&hellip; The app goes complicated way faster than I expect, so I decided to make a big structure change by using an event bus system. I have not compared other event bus library but otto works for me perfectly.</p>

<h3>ActionBar</h3>

<p>Before the official actionbar-compact was released after GoogleIO, I think most people will use ActionBarSherlock. However, I implmented my own. I think it gives me more flexibility if you implemented your own, especially when you dont need those inflate from menu support. The down side is you lost support from all opensource projects, I have to implement my own refresh/progress buttons, ShareActionProvider, cannot play with those fancy fading actionbar, not boring actionbar library, may even need to write my own android style pull to refresh. Those disadvantage are usually enough to stop me from using my own implementation, but I decided to keep it. Mostly because it turns out not that hard to migrate to my own actionbar as long as it is opensourced and I do not have to worry about two libraries not working together (because I am not using any&hellip;).</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2013-12-23T23:48:54+08:00" pubdate data-updated="true">Dec 23<span>rd</span>, 2013</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/android/'>android</a>, <a class='category' href='/blog/categories/github/'>github</a>


</div>
	
</div>
</article>

<nav id="pagenavi">
    
    
        <a href="/blog/page/2/" class="next">Next</a>
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav></div>
	<footer id="footer" class="inner">Copyright &copy; 2014

    Billy Ng

</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->






</body>
</html>