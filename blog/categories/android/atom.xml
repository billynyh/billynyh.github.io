<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: android | Just code it]]></title>
  <link href="http://billynyh.github.io//blog/categories/android/atom.xml" rel="self"/>
  <link href="http://billynyh.github.io//"/>
  <updated>2014-03-31T00:48:51+08:00</updated>
  <id>http://billynyh.github.io//</id>
  <author>
    <name><![CDATA[Billy Ng]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Notes on migrating Android project from ant to gradle]]></title>
    <link href="http://billynyh.github.io//blog/2014/03/31/gradle-migration/"/>
    <updated>2014-03-31T00:44:28+08:00</updated>
    <id>http://billynyh.github.io//blog/2014/03/31/gradle-migration</id>
    <content type="html"><![CDATA[<p>Few months ago, I spent a little time to try migrating my Android project from to gradle, although it is announced in last Google IO (May 2013), and saw some big companies switched to it early, I considered that not ready that time and decided to wait for later version.</p>

<h3>Projects structures</h3>

<p>The project I am working on used some library projects like pull to refresh, facebook sdk, google play services, etc, due to the limitation of the old ant build system, you have to include the source and compile with your app. We also splitted some of our own components to separate library projects for reuseing in other projects. Currently my app is depending on 14 other library projects, and it takes about 3 minutes to have do a clean build.</p>

<p>We also use git submodules to include projects from other repositories. I am still not sure if this is the right way to manage projects especially when we keep modifying the libraries. It increases the complexity when we have multiple branches in development, and causes some pains when merging codes.</p>

<h3>First migration attempt</h3>

<p>I tried to migrate to gradle few months ago, when Android studio was in version 0.2 I think. One of the unknown part of the migration, it&rsquo;s 0 or 100, no 50% migrated. Even you build every library successfully, it does not mean you are getting close to finish the migration. In my case, I first made a simple app to get familiar with the build system, then migrated my libraries one by one, but guess what I got when I tried to have a complete build? Out of memory&hellip; I googled a little bit and found a way to increase the memory limit but still got the same error, in both command line and Android studio.</p>

<p>I didn&rsquo;t put more time on that since the ant scripts still work at that time and I got (many) other tasks pending.</p>

<h3>Second attempt</h3>

<p>I recently reopened the migration task, mainly for 3 reasons.</p>

<ol>
<li>Eclipse can&rsquo;t handle the project anymore. When I tried to add some code in a core library project that is also used in 3 other library projects, eclipse just hangs there and I have to kill it myself.</li>
<li>Need more tools for development. Actually this is one of the reason of my first attempt of migration, I had some (simple) scripts/code generators to help development, some are standalone but some are hooked into the build flow. It does not make sense to keep developing scripts based on ant if there is a migration coming, so I didn&rsquo;t add any scripts in the last 6 months. In order to continue the development, the migration task now becomes a blocker.</li>
<li>Team expand. We are expecting more man power on Android, the migration has to be done before they start.</li>
</ol>


<p>Not like last time, this is no longer a &ldquo;try out&rdquo;, it has to be done, no matter how many effort required.</p>

<p>After reinstalling the Android studio and gradle, I still got the out of memory error during compile. At this point, even I can get through the compile task of each library, I may got other error when combining everything in the app project, so I have to do some experiments first. I compiled all library projects to aar and uploaded to local maven repositories, this also required me to modify the build.gradle of the app project to use aar instead of compile form source. With some luck, I can compile the app with those aar successfully.</p>

<p>Next step is to make it fits my development workflow. Some library projects need to compile from source and those relatively stable libraries can use aar. Fortunately it worked as expect and did not gave me out of memory error, and even better, it also worked on Android studio without any extra modification.</p>

<p>Migrating the basic workflow is just the beginning, there are still many things to test before using it to do release, like app signing, proguard, build with different package names, etc&hellip; But before those tasks, there is still one problem needed to work on. I am not sure it is just me, but the gradle configure time seems very long with multi projects setup, and it may not suppose to be that slow. I posted my question on <a href="https://plus.google.com/u/0/105980838674582844427/posts/8sYLTN6WyCt">Google plus</a> and got some quick responses from Xavier Ducrohet. He said the configure time should be around 3s if run with daemon, but what I got is at least 10s for every one, even a simple &ldquo;gradle projects&rdquo; command call. I am not sure if this is the best I can get but it would not be a great development experience if every run need to wait for 10s and the actual compile is just 2s.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[A deeper look of ViewPager and FragmentStatePagerAdaper]]></title>
    <link href="http://billynyh.github.io//blog/2014/03/02/fragment-state-pager-adapter/"/>
    <updated>2014-03-02T21:01:40+08:00</updated>
    <id>http://billynyh.github.io//blog/2014/03/02/fragment-state-pager-adapter</id>
    <content type="html"><![CDATA[<h2>Background</h2>

<p>Last week I was working on a remove action on ViewPager, so based on the knowledge from ListView&rsquo;s adapter, I tried removing the item and called notifyDataSetChanged, it didn&rsquo;t work. So I googled a little bit and found that I need to override the getItemPosition method in PagerAdapter when removing item.</p>

<p>This is the doc from PagerAdapter</p>

<blockquote><p>A data set change may involve pages being added, removed, or changing position. The ViewPager will keep the current page active provided the adapter implements the method getItemPosition(Object).</p></blockquote>

<p>and description of getItemPosition</p>

<blockquote><p>Called when the host view is attempting to determine if an item&rsquo;s position has changed. Returns POSITION_UNCHANGED if the position of the given item has not changed or POSITION_NONE if the item is no longer present in the adapter.</p></blockquote>

<p>Then I put it in my pager adapter, got a different behavior, but still not work correctly. Three thoughts came to me immediately:</p>

<ol>
<li>something wrong in my getItemPosition</li>
<li>something wrong when I integrate with my other code.</li>
<li>something wrong in FragmentStatePagerAdapter</li>
</ol>


<p>For 1, it is easy to verify by printing logs and it looked good to me. 2, I don&rsquo;t think so but still spend some time to check my code first. As expected, problem still existed. I always have a problem with Fragment lifecycle, everytime I thought I understand more, a new problem came out and breaks my understanding of fragment lifecycle. I tried hard to avoid go deep to the implementation of FragmentStatePagerAdapter, but this time I have no choice.</p>

<h2>FragmentStatePagerAdapter</h2>

<p>I am a little bit surprised by the <a href="https://android.googlesource.com/platform/frameworks/support/+/refs/heads/master/v4/java/android/support/v4/app/FragmentStatePagerAdapter.java">short code length</a> of it.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="c1">//&lt;a href=&quot;https://android.googlesource.com/platform/frameworks/support/+/refs/heads/master/v4/java/android/support/v4/app/FragmentStatePagerAdapter.java&quot;&gt;https://android.googlesource.com/platform/frameworks/support/+/refs/heads/master/v4/java/android/support/v4/app/FragmentStatePagerAdapter.java&lt;/a&gt;</span>
</span><span class='line'><span class="kd">private</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Fragment</span><span class="o">&gt;</span> <span class="n">mFragments</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Fragment</span><span class="o">&gt;();&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="nd">@Override</span>
</span><span class='line'><span class="kd">public</span> <span class="n">Object</span> <span class="nf">instantiateItem</span><span class="o">(</span><span class="n">ViewGroup</span> <span class="n">container</span><span class="o">,</span> <span class="kt">int</span> <span class="n">position</span><span class="o">)</span> <span class="o">{&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="k">if</span> <span class="o">(</span><span class="n">mFragments</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">position</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">Fragment</span> <span class="n">f</span> <span class="o">=</span> <span class="n">mFragments</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">position</span><span class="o">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">f</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">f</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="o">(</span><span class="n">mCurTransaction</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">mCurTransaction</span> <span class="o">=</span> <span class="n">mFragmentManager</span><span class="o">.</span><span class="na">beginTransaction</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">Fragment</span> <span class="n">fragment</span> <span class="o">=</span> <span class="n">getItem</span><span class="o">(</span><span class="n">position</span><span class="o">);</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="n">mFragments</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">position</span><span class="o">,</span> <span class="n">fragment</span><span class="o">);</span>
</span><span class='line'><span class="n">mCurTransaction</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">container</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="n">fragment</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">return</span> <span class="n">fragment</span><span class="o">;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;}&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="nd">@Override</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">destroyItem</span><span class="o">(</span><span class="n">ViewGroup</span> <span class="n">container</span><span class="o">,</span> <span class="kt">int</span> <span class="n">position</span><span class="o">,</span> <span class="n">Object</span> <span class="n">object</span><span class="o">)</span> <span class="o">{&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">Fragment</span> <span class="n">fragment</span> <span class="o">=</span> <span class="o">(</span><span class="n">Fragment</span><span class="o">)</span><span class="n">object</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="o">(</span><span class="n">mCurTransaction</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">mCurTransaction</span> <span class="o">=</span> <span class="n">mFragmentManager</span><span class="o">.</span><span class="na">beginTransaction</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="n">mSavedState</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">position</span><span class="o">,</span> <span class="n">mFragmentManager</span><span class="o">.</span><span class="na">saveFragmentInstanceState</span><span class="o">(</span><span class="n">fragment</span><span class="o">));</span>
</span><span class='line'><span class="n">mFragments</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">position</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="n">mCurTransaction</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">fragment</span><span class="o">);</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;}&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Here is what FragmentStatePagerAdapter does in instantiateItem and destroyItem, in short, it maintains an ArrayList mFragments which mFragments.get(i) returns the fragment that is in position i, null if fragment not in fragment manager. By default, ViewPager will keep one item before and after current item, so if you are at position 1 (0-based), mFragments will be like</p>

<table>
<thead>
<tr>
<th> 0 </th>
<th> 1 </th>
<th> 2 </th>
<th> 3 </th>
<th> 4 </th>
</tr>
</thead>
<tbody>
<tr>
<td> F0 </td>
<td> F1 </td>
<td> F2 </td>
<td> null </td>
<td> null </td>
</tr>
</tbody>
</table>


<h2>Remove item</h2>

<p>What will happen if I remove F1 and call notifyDataSetChanged? the result of getItemPosition should be
<code>
F0: 0 (or POSITION_UNCHANGED?)
F1: POSITION_NONE
F2: 1
</code>
Right?</p>

<p>Then I expect mFragments become</p>

<table>
<thead>
<tr>
<th> 0 </th>
<th> 1 </th>
<th> 2 </th>
<th> 3 </th>
<th> 4 </th>
</tr>
</thead>
<tbody>
<tr>
<td> F0 </td>
<td> F2 </td>
<td> null </td>
<td> null </td>
<td> null </td>
</tr>
</tbody>
</table>


<p>But from the source of FragmentStatePagerAdapter, I don&rsquo;t think it has any handling of it. I copied the source and added some log to dump mFragments out, and find that it is like</p>

<table>
<thead>
<tr>
<th align="left"> Step </th>
<th> What I see </th>
<th> 0 </th>
<th> 1 </th>
<th> 2 </th>
<th> 3 </th>
<th> 4 </th>
</tr>
</thead>
<tbody>
<tr>
<td align="left"> 1 </td>
<td>curr item F1 </td>
<td> F0 </td>
<td> F1 </td>
<td> F2 </td>
<td> null </td>
<td> null </td>
</tr>
<tr>
<td align="left"> 2 </td>
<td>after remove F1, F2 becomes curr item </td>
<td> F0 </td>
<td> null </td>
<td>  F2 </td>
<td> null </td>
<td> null </td>
</tr>
<tr>
<td align="left"> 3 </td>
<td>swipe next, no item displayed but F4 instantiated </td>
<td> null </td>
<td> null </td>
<td> F2 </td>
<td> F4 </td>
<td> null </td>
</tr>
<tr>
<td align="left"> 4 </td>
<td>swipe next, curr item F4 </td>
<td> null </td>
<td> null </td>
<td> F2 </td>
<td> F4 </td>
<td> F5 </td>
</tr>
<tr>
<td align="left"> 5 </td>
<td>swipe next, curr item F5 </td>
<td> null </td>
<td> null </td>
<td> null </td>
<td> F4 </td>
<td> F5 </td>
</tr>
</tbody>
</table>


<p>then the app crashed on step 5 when it tries to destroy F2.</p>

<h2>Dafaq?</h2>

<p>First of all, what happened in step 2? It just removed F1 and left F2 there, and ViewPager just display it?</p>

<p>Yes, something like that.</p>

<ol>
<li>When F1 is removed and called notifyDataSetChanged, ViewPager will call getItemPosition for each item, in the order of F0, F1, F2.</li>
<li>When POSITION_NONE is returned for F1, adapter&rsquo;s destroyItem is called and F1 is removed from FragmentManager and mFragments.</li>
<li>Then for F2, it returned the new position 1, which match the current position, so ViewPager uses F2 directly, but <strong>leave mFragments in adapter not updated</strong>.</li>
<li>After that, it should create F3 by calling instantiateItem on position 2, however, as mFragments still keeping F2 in position 2, it is directly returned and F3 is never created.</li>
<li>In the first swipe after remove, ViewPager tries to display data in position 2 which the fragment F2 is already used in position 1. At the same time, F0 is removed from FragmentManager, F4 is created as item in position 3.</li>
<li>Second swipe, position 3(F4) becomes current item, position 1(F2) removed from FragmentManager, F5 created for position 4.</li>
<li>Third swipe, position 4(F5) becomes current item, ViewPager tried to destroy position 2, but position 2 is also F2, destroying that cause

<blockquote><p>IllegalStateException: Fragment {} is not currently in the FragmentManager.</p></blockquote></li>
</ol>


<h2>Workaround</h2>

<p>When I tried to isolate the problem, I accidentally return POSITION_NONE for all item, and it actually gave the result I want without crash. It worked because all fragments are destroyed in notifyDataSetChanged and re-instantiated, it does the tricks but may cause other performance problem so I am looking for a better solution.</p>

<h2>Possible fix</h2>

<p>I have not start yet, but as mFragments in FragmentStatePagerAdapter is private, extending it and override some methods cannot change it at all. Good news is, you can copy the source and compile it yourself.</p>

<p>To fix this, you need to find a way to update mFragments after checking getItemPosition and destroyItem. My initial thoughts is to handle that in finishUpdate(). The new finishUpdate will become something like:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Override</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">finishUpdate</span><span class="o">(</span><span class="n">ViewGroup</span> <span class="n">container</span><span class="o">)</span> <span class="o">{&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="k">if</span> <span class="o">(</span><span class="n">mCurTransaction</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">mCurTransaction</span><span class="o">.</span><span class="na">commitAllowingStateLoss</span><span class="o">();</span>
</span><span class='line'>    <span class="n">mCurTransaction</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>    <span class="n">mFragmentManager</span><span class="o">.</span><span class="na">executePendingTransactions</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">ArrayList</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">Fragment</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">update</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">Fragment</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;();</span>
</span><span class='line'><span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">,</span> <span class="n">n</span><span class="o">=</span><span class="n">mFragments</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span> <span class="n">n</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">Fragment</span> <span class="n">f</span> <span class="o">=</span> <span class="n">mFragments</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">f</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">continue</span><span class="o">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">getItemPosition</span><span class="o">(</span><span class="n">f</span><span class="o">);</span>
</span><span class='line'>    <span class="k">while</span> <span class="o">(</span><span class="n">update</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;=</span> <span class="n">pos</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">update</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="n">update</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">pos</span><span class="o">,</span> <span class="n">f</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="n">mFragments</span> <span class="o">=</span> <span class="n">update</span><span class="o">;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>One problem is that finishUpdate is also called in other places so need to make sure this change will not break other code and not causing performance issue.</p>

<h2>About this post&hellip;</h2>

<p>At first I just want to write a short notes on the problem I met during work, then I tried to isolate the problem and reproduce it, tried to find similar posts on stackoverflow, read the soure code to confirm the problem, and even tried to fix it&hellip; This is totally not my plan for this weekend but I actually quite enjoy reading the source code of support library.</p>

<h2>Reference</h2>

<ul>
<li><a href="https://plus.google.com/u/0/105980838674582844427/posts/a1xwgEEehCs">Discussion on gplus</a> thx Adam Powell for replying my post.</li>
<li>Source of <a href="https://android.googlesource.com/platform/frameworks/support/+/refs/heads/master/v4/java/android/support/v4/view/ViewPager.java">ViewPager</a> and <a href="https://android.googlesource.com/platform/frameworks/support/+/refs/heads/master/v4/java/android/support/v4/app/FragmentStatePagerAdapter.java">FragmentStatePagerAdapter</a></li>
<li><a href="https://code.google.com/p/android/issues/detail?id=37990">https://code.google.com/p/android/issues/detail?id=37990</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Useful features I missed during Android development]]></title>
    <link href="http://billynyh.github.io//blog/2014/02/23/features-missed-during-development/"/>
    <updated>2014-02-23T19:36:59+08:00</updated>
    <id>http://billynyh.github.io//blog/2014/02/23/features-missed-during-development</id>
    <content type="html"><![CDATA[<p>This weekend, I am working on my Muzei extension and try to add a setting page to it. It is not hard to write everything myself, but I was not in the mood of writing code from scratch, so I just copy code from <a href="https://github.com/flavienlaurent/muzeihash">other opensource project</a>. Modifying other&rsquo;s code does not always speed up your development when your task is so simple, but you can take this chance to read other&rsquo;s code at the same time.</p>

<p>I don&rsquo;t consider myself learned Android development correctly, but I guess most people started like me. I started with a small project, lookup the doc for the features I need, then learn other features while doing other projects.When you learn like this, it is easy to miss out simple features. Here are what I found this week:</p>

<h2>Show divider in LinearLayout</h2>

<p>Can&rsquo;t believe I missed this, there was a couple times that I need to append dummy view to act as divider. The worst thing about adding divider view yourself is not the extra code you added, is when you try to control visiblity of elements, you need to handle the dividers also.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">LinearLayout</span> <span class="nl">xmlns:</span><span class="n">android</span><span class="o">=&amp;</span><span class="n">ldquo</span><span class="o">;&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span><span class="o">&gt;</span><span class="nl">http:</span><span class="c1">//schemas.android.com/apk/res/android&lt;/a&gt;&amp;rdquo;&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="nl">android:</span><span class="n">layout_width</span><span class="o">=</span><span class="s">&quot;match_parent&quot;</span>
</span><span class='line'><span class="nl">android:</span><span class="n">layout_height</span><span class="o">=</span><span class="s">&quot;match_parent&quot;</span>
</span><span class='line'><span class="nl">android:</span><span class="n">orientation</span><span class="o">=</span><span class="s">&quot;horizontal&quot;</span>
</span><span class='line'><span class="nl">android:</span><span class="n">showDividers</span><span class="o">=</span><span class="s">&quot;middle&quot;</span>
</span><span class='line'><span class="nl">android:</span><span class="n">divider</span><span class="o">=</span><span class="s">&quot;?android:dividerVertical&quot;</span>
</span><span class='line'><span class="nl">android:</span><span class="n">dividerPadding</span><span class="o">=</span><span class="s">&quot;4dp&quot;</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;&lt;/</span><span class="n">LinearLayout</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h2>CheckedTextView</h2>

<p>The first time when I want to have checkbox put on the right side of the text, I went through the available options of CheckBox class and cannot find any good, then I go to google and stackoverflow, <a href="http://stackoverflow.com/questions/5000213/how-to-set-the-checkbox-on-the-right-side-of-the-text">first solution</a> is to put a TextView to the left of CheckBox. Usually I will just stop here and start coding, but it is obviously not good enoguh, as now you can only trigger it by clicking the checkbox but not the whole text+checkbox.</p>

<p>If you tried the multiple choice feature of ListView, you will see it is exactly the behavior you look for, a little <a href="https://android.googlesource.com/platform/frameworks/base/+/master/core/res/res/layout/simple_list_item_multiple_choice.xml">dig in</a> will give you CheckedTextView.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="n">CheckedTextView</span> <span class="nl">xmlns:</span><span class="n">android</span><span class="o">=&amp;</span><span class="n">ldquo</span><span class="o">;&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span><span class="o">&gt;</span><span class="nl">http:</span><span class="c1">//schemas.android.com/apk/res/android&lt;/a&gt;&amp;rdquo;&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="nl">android:</span><span class="n">id</span><span class="o">=</span><span class="s">&quot;@android:id/text1&quot;</span>
</span><span class='line'><span class="nl">android:</span><span class="n">layout_width</span><span class="o">=</span><span class="s">&quot;match_parent&quot;</span>
</span><span class='line'><span class="nl">android:</span><span class="n">layout_height</span><span class="o">=</span><span class="s">&quot;?android:attr/listPreferredItemHeightSmall&quot;</span>
</span><span class='line'><span class="nl">android:</span><span class="n">textAppearance</span><span class="o">=</span><span class="s">&quot;?android:attr/textAppearanceListItemSmall&quot;</span>
</span><span class='line'><span class="nl">android:</span><span class="n">gravity</span><span class="o">=</span><span class="s">&quot;center_vertical&quot;</span>
</span><span class='line'><span class="nl">android:</span><span class="n">checkMark</span><span class="o">=</span><span class="s">&quot;?android:attr/listChoiceIndicatorMultiple&quot;</span>
</span><span class='line'><span class="nl">android:</span><span class="n">paddingStart</span><span class="o">=</span><span class="s">&quot;?android:attr/listPreferredItemPaddingStart&quot;</span>
</span><span class='line'><span class="nl">android:</span><span class="n">paddingEnd</span><span class="o">=</span><span class="s">&quot;?android:attr/listPreferredItemPaddingEnd&quot;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;/&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>You can even extend other layout with <a href="http://developer.android.com/reference/android/widget/Checkable.html">Checkable</a> interface, more detail <a href="http://chris.banes.me/2013/03/22/checkable-views/">here</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[First play on Muzei]]></title>
    <link href="http://billynyh.github.io//blog/2014/02/16/first-play-on-muzei/"/>
    <updated>2014-02-16T23:05:43+08:00</updated>
    <id>http://billynyh.github.io//blog/2014/02/16/first-play-on-muzei</id>
    <content type="html"><![CDATA[<p><a href="https://github.com/romannurik/muzei">Muzei live wallpaper</a> is a new opensource project from Roman Nurik which provide a nice API for other developers to build extension on it easily. Just a few days after its release on Feb 12, you can already find quite many different <a href="https://play.google.com/store/search?q=muzei&amp;c=apps">data source</a> for it. So I played for a while today and found that it is&hellip; really easy to implement your own data source.</p>

<p>Here is a quick start on creating the extension.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyArtSource</span> <span class="kd">extends</span> <span class="n">RemoteMuzeiArtSource</span> <span class="o">{&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">UPDATE_INTERVAL</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">;</span> <span class="c1">// 60min</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="nf">MyArtSource</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">super</span><span class="o">(</span><span class="s">&quot;my-art-source&quot;</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nd">@Override</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">();</span>
</span><span class='line'>    <span class="n">setUserCommands</span><span class="o">(</span><span class="n">BUILTIN_COMMAND_ID_NEXT_ARTWORK</span><span class="o">);</span> <span class="c1">// manual switch image</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@Override</span>
</span><span class='line'><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onTryUpdate</span><span class="o">(</span><span class="kt">int</span> <span class="n">reason</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">RetryException</span> <span class="o">{</span>
</span><span class='line'>    <span class="c1">// fetch title, imageUrl, id, url from remote or hardcode</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">publishArtwork</span><span class="o">(</span><span class="k">new</span> <span class="n">Artwork</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
</span><span class='line'>        <span class="o">.</span><span class="na">title</span><span class="o">(</span><span class="n">title</span><span class="o">)</span>
</span><span class='line'>        <span class="o">.</span><span class="na">imageUri</span><span class="o">(</span><span class="n">Uri</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">imageUrl</span><span class="o">))</span>
</span><span class='line'>        <span class="o">.</span><span class="na">token</span><span class="o">(</span><span class="n">id</span><span class="o">)</span>
</span><span class='line'>        <span class="o">.</span><span class="na">viewIntent</span><span class="o">(</span><span class="k">new</span> <span class="n">Intent</span><span class="o">(</span><span class="n">Intent</span><span class="o">.</span><span class="na">ACTION_VIEW</span><span class="o">,</span> <span class="n">Uri</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">url</span><span class="o">)))</span>
</span><span class='line'>        <span class="o">.</span><span class="na">build</span><span class="o">());</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">scheduleUpdate</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">+</span> <span class="n">UPDATE_INTERVAL</span><span class="o">);</span> <span class="c1">// switch image after 60min</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>You can find my Muzei 9GAG extension on <a href="https://play.google.com/store/apps/details?id=com.billynyh.muzei9gag">Play store</a>, source code available on <a href="https://github.com/billynyh/android-muzei-9gag">Github</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Implementing zoomable view - part 1]]></title>
    <link href="http://billynyh.github.io//blog/2014/02/15/implmenting-view-gesture-1/"/>
    <updated>2014-02-15T22:27:54+08:00</updated>
    <id>http://billynyh.github.io//blog/2014/02/15/implmenting-view-gesture-1</id>
    <content type="html"><![CDATA[<p>Last year I implemented a custom view that supports different gestures including zoom(scale), scroll, double tap. As a newbie on custom view, the whole measuring and drawing already spent me some time, so the gesture control turned out enough to use but was actually incomplete and not finished.</p>

<p>Recently, I have a task to embed my custom view to ViewPager and other custom ViewGroup that intercept touch events. As expected, my custom view takes all the touch events so the ViewPager cannot perform horizontal swipe. I woule like to take this chance to review my gesture handling and hopefully can make it work.</p>

<p>What I did last year is mostly referencing Chris Banes&rsquo;s <a href="https://github.com/chrisbanes/PhotoView/blob/master/library/src/uk/co/senab/photoview/PhotoViewAttacher.java">PhotoView library</a>. The basic idea is:</p>

<ul>
<li>create a &ldquo;view attacher&rdquo; that implements a View.OnTouchListener</li>
<li>create instance of <a href="http://developer.android.com/reference/android/view/ScaleGestureDetector.html">ScaleGesutreDetector</a> and <a href="http://developer.android.com/reference/android/view/GestureDetector.html">GestureDetector</a>, notice that <a href="https://github.com/chrisbanes/PhotoView/blob/master/library/src/uk/co/senab/photoview/gestures/GestureDetector.java">PhotoView&rsquo;s GestureDetector</a> is not the one in Android framework</li>
<li>use those detectors in OnTouchListener&rsquo;s onTouch method</li>
</ul>


<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ZoomableViewAttacher</span> <span class="kd">implements</span> <span class="n">View</span><span class="o">.</span><span class="na">OnTouchListener</span> <span class="o">{&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">GestureDetector</span> <span class="n">mGestureDetector</span><span class="o">;</span>
</span><span class='line'><span class="n">ScaleGestureDetector</span> <span class="n">mScaleGestureDetector</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="o">...</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@Override</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">onTouch</span><span class="o">(</span><span class="n">View</span> <span class="n">v</span><span class="o">,</span> <span class="n">MotionEvent</span> <span class="n">ev</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="kt">boolean</span> <span class="n">handled</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="n">mGestureDetector</span> <span class="o">&amp;</span><span class="n">amp</span><span class="o">;&amp;</span><span class="n">amp</span><span class="o">;</span> <span class="n">mGestureDetector</span><span class="o">.</span><span class="na">onTouchEvent</span><span class="o">(</span><span class="n">ev</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">handled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="n">mScaleGestureDetector</span> <span class="o">&amp;</span><span class="n">amp</span><span class="o">;&amp;</span><span class="n">amp</span><span class="o">;</span> <span class="n">mScaleGestureDetector</span><span class="o">.</span><span class="na">onTouchEvent</span><span class="o">(</span><span class="n">ev</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">handled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">handled</span><span class="o">;</span> <span class="c1">// or just return true;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>So far this worked for me last year as I am using the view alone, I did not have to consider the case that the view&rsquo;s parent intercepted the touch event.</p>

<p>Now the problem is, how do I prevent the ViewPager intercepting my touch event? After digging deeper, I found a requestDisallowInterceptTouchEvent method in ViewParent. According to the framework <a href="http://developer.android.com/reference/android/view/ViewParent.html#requestDisallowInterceptTouchEvent(boolean)">doc</a></p>

<p><blockquote><p>Called when a child does not want this parent and its ancestors to intercept touch events with onInterceptTouchEvent(MotionEvent).</p></p><p><p>This parent should pass this call onto its parents. This parent must obey this request for the duration of the touch (that is, only clear the flag after this parent has received an up or a cancel.</p></blockquote></p>

<p>Which means, if I call the method in correct time, I should be able to enable and disable ViewPager&rsquo;s onInterceptTouchEvent. Googled a little bit on requestDisallowInterceptTouchEvent, found some example on StackOverflow like</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="k">switch</span> <span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">getAction</span><span class="o">())</span> <span class="o">{&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="k">case</span> <span class="n">MotionEvent</span><span class="o">.</span><span class="na">ACTION_DOWN</span><span class="o">:</span>
</span><span class='line'>    <span class="n">parent</span><span class="o">.</span><span class="na">requestDisallowInterceptTouchEvent</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span><span class='line'>    <span class="k">break</span><span class="o">;</span>
</span><span class='line'><span class="k">case</span> <span class="n">MotionEvent</span><span class="o">.</span><span class="na">ACTION_CANCEL</span><span class="o">:</span>
</span><span class='line'><span class="k">case</span> <span class="n">MotionEvent</span><span class="o">.</span><span class="na">ACTION_UP</span><span class="o">:</span>
</span><span class='line'>    <span class="n">parent</span><span class="o">.</span><span class="na">requestDisallowInterceptTouchEvent</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
</span><span class='line'>    <span class="k">break</span><span class="o">;</span>
</span><span class='line'><span class="k">default</span><span class="o">:</span>
</span><span class='line'>    <span class="k">break</span><span class="o">;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>This is obviously not enough for me, since it disabled the parent for the whole touch motion, if I touch on my custom and actually want to perform a page swipe on ViewPager, thie code will definitely break the ViewPager usage.</p>

<p>My first attempt is something like:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="k">switch</span> <span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">getAction</span><span class="o">())</span> <span class="o">{&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="k">case</span> <span class="n">MotionEvent</span><span class="o">.</span><span class="na">ACTION_DOWN</span><span class="o">:</span>
</span><span class='line'>    <span class="n">parent</span><span class="o">.</span><span class="na">requestDisallowInterceptTouchEvent</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span><span class='line'>    <span class="k">break</span><span class="o">;</span>
</span><span class='line'><span class="k">case</span> <span class="n">MotionEvent</span><span class="o">.</span><span class="na">ACTION_CANCEL</span><span class="o">:</span>
</span><span class='line'><span class="k">case</span> <span class="n">MotionEvent</span><span class="o">.</span><span class="na">ACTION_UP</span><span class="o">:</span>
</span><span class='line'>    <span class="n">parent</span><span class="o">.</span><span class="na">requestDisallowInterceptTouchEvent</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
</span><span class='line'>    <span class="k">break</span><span class="o">;</span>
</span><span class='line'><span class="k">default</span><span class="o">:</span>
</span><span class='line'>    <span class="k">break</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="o">(!</span><span class="n">canScroll</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>    <span class="c1">// re-enable parents&#39; onInterceptTouchEvent</span>
</span><span class='line'>    <span class="n">parent</span><span class="o">.</span><span class="na">requestDisallowInterceptTouchEvent</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>It would be great if GestureDetector can directly give me the information needed for my canScroll() method. However, it seems that GestureDetector need a few events to determine if it is a scroll, there is a gap of 3-5 events between my first ACTION_DOWN and onScoll callback, so I need a better way to determine the condition for calling parent.requestDisallowInterceptTouchEvent().</p>

<p>In part 2, I will continue with the implementation of canScroll() method.</p>
]]></content>
  </entry>
  
</feed>
